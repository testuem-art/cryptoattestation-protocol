<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoAttestation dApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 2rem auto; 
            padding: 1rem; 
            line-height: 1.6; 
            background-color: #f5f5f5;
        }
        h1, h2 {
            color: #2c3e50;
        }
        button { 
            padding: 12px 18px; 
            margin: 8px 5px; 
            cursor: pointer; 
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            font-weight: bold; 
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #3e8e41;
        }
        button:disabled { 
            background-color: #cccccc; 
            cursor: not-allowed; 
        }
        input { 
            padding: 10px; 
            margin: 8px 0; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        .section { 
            margin-bottom: 2rem; 
            padding: 1.5rem; 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #console { 
            background: #2c3e50; 
            color: #ecf0f1; 
            padding: 1.2rem; 
            margin-top: 1.5rem; 
            border-radius: 8px; 
            font-family: monospace; 
            white-space: pre-wrap; 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .status-ok { color: #2ecc71; }
        .status-error { color: #e74c3c; }
        .status-wait { color: #f39c12; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .attestation-card {
            margin: 15px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>üöÄ dApp –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è–º–∏</h1>
    <p>–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Ç–∏ Ethereum. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ MetaMask –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —Ç–æ–π –∂–µ —Å–µ—Ç–∏, –∫—É–¥–∞ –±—ã–ª —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç.</p>

    <div class="section">
        <h2>1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞</h2>
        <button id="connectWallet">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å MetaMask</button>
        <span id="loader" class="loader" style="display: none;"></span>
        <p>–°—Ç–∞—Ç—É—Å: <span id="walletStatus" class="status-wait">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span></p>
        <p>–°–µ—Ç—å: <span id="networkStatus">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span></p>
    </div>

    <div class="section">
        <h2>2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏</h2>
        <p><strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –≥–∞–∑–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –±–ª–æ–∫—á–µ–π–Ω.</p>
        <input type="text" id="assetInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Serial-Number-123)">
        <input type="text" id="dataInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Passed-QA-2024)">
        <button id="createAttestation" disabled>‚úÖ –°–æ–∑–¥–∞—Ç—å –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—é</button>
    </div>

    <div class="section">
        <h2>3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–π</h2>
        <p>–≠—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞ –∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç –∑–∞—Ç—Ä–∞—Ç –≥–∞–∑–∞.</p>
        <input type="text" id="assetQueryInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏">
        <button id="getAttestationCount" disabled>üîç –£–∑–Ω–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</button>
        <button id="getAllAttestations" disabled>üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏</button>
        <div id="attestationResults"></div>
    </div>

    <div id="console"><b>–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π:</b>\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –ø–æ–¥–∫–ª—é—á–∏—Ç–µ MetaMask.\n</div>

    <script>
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–í–ê–®–ò –î–ê–ù–ù–´–ï)
        const contractAddress = "0xDA0bab807633f07f013f94DD0E6A4F96F8742B53";
        const contractABI = [{"inputs":[{"internalType":"bytes32","name":"assetHash","type":"bytes32"},{"internalType":"bytes32","name":"dataHash","type":"bytes32"}],"name":"addAttestation","outputs":[],"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"assetHash","type":"bytes32"},{"indexed":true,"internalType":"address","name":"verifier","type":"address"},{"indexed":false,"internalType":"bytes32","name":"dataHash","type":"bytes32"}],"name":"AttestationAdded","type":"event"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"assetAttestations","outputs":[{"internalType":"address","name":"verifier","type":"address"},{"internalType":"bytes32","name":"dataHash","type":"bytes32"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"assetHash","type":"bytes32"}],"name":"getAttestationCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        let provider = null;
        let signer = null;
        let contract = null;
        let userAddress = null;
        let currentChainId = null;

        // –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê
        const connectButton = document.getElementById('connectWallet');
        const statusSpan = document.getElementById('walletStatus');
        const networkSpan = document.getElementById('networkStatus');
        const createButton = document.getElementById('createAttestation');
        const countButton = document.getElementById('getAttestationCount');
        const getAllButton = document.getElementById('getAllAttestations');
        const consoleOutput = document.getElementById('console');
        const loader = document.getElementById('loader');

        // –§–£–ù–ö–¶–ò–Ø –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø
        function logToConsole(message) {
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            consoleOutput.innerHTML += `[${timestamp}] ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // –§–£–ù–ö–¶–ò–Ø –ü–†–ï–û–ë–†–ê–ó–û–í–ê–ù–ò–Ø –°–¢–†–û–ö–ò –í –•–≠–®
        function stringToBytes32(inputString) {
            if (typeof ethers === 'undefined') {
                logToConsole('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ ethers –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å!');
                throw new Error('Ethers library not loaded');
            }
            return ethers.utils.id(inputString);
        }

        // –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò METAMASK (–î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –ò –ü–ö)
        function checkMetaMask() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –±—Ä–∞—É–∑–µ—Ä –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º –±—Ä–∞—É–∑–µ—Ä–æ–º MetaMask
            const isInMobileApp = /MetaMaskMobile/.test(navigator.userAgent);
            
            if (typeof window.ethereum === 'undefined' && !isInMobileApp) {
                logToConsole("‚ùå MetaMask –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω.");
                logToConsole("‚ÑπÔ∏è –î–ª—è –ü–ö: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ MetaMask.");
                logToConsole("‚ÑπÔ∏è –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ MetaMask –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä.");
                statusSpan.textContent = "–¢—Ä–µ–±—É–µ—Ç—Å—è MetaMask";
                statusSpan.className = 'status-error';
                connectButton.disabled = true;
                return false;
            }
            
            if (isInMobileApp) {
                logToConsole("‚úì –û–±–Ω–∞—Ä—É–∂–µ–Ω –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä MetaMask");
            } else {
                logToConsole("‚úì –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ MetaMask");
            }
            
            return true;
        }

        // –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–¢–ê–¢–£–°–ê –ö–ù–û–ü–û–ö
        function updateButtonStates(isConnected) {
            createButton.disabled = !isConnected;
            countButton.disabled = !isConnected;
            getAllButton.disabled = !isConnected;
        }

        // –û–ë–†–ê–ë–û–¢–ß–ò–ö –ò–ó–ú–ï–ù–ï–ù–ò–Ø –°–ï–¢–ò
        async function handleChainChanged(chainId) {
            logToConsole("–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–µ—Ç–∏...");
            currentChainId = chainId;
            networkSpan.textContent = `ID —Å–µ—Ç–∏: ${chainId}`;
            await setupContract();
        }

        // –û–ë–†–ê–ë–û–¢–ß–ò–ö –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ê–ö–ö–ê–£–ù–¢–ê
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                logToConsole("‚ö†Ô∏è –ê–∫–∫–∞—É–Ω—Ç –æ—Ç–∫–ª—é—á–µ–Ω. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ —Å–Ω–æ–≤–∞.");
                statusSpan.textContent = "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω";
                statusSpan.className = 'status-wait';
                updateButtonStates(false);
            } else if (accounts[0] !== userAddress) {
                logToConsole("‚ö†Ô∏è –ê–∫–∫–∞—É–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                window.location.reload();
            }
        }

        // –§–£–ù–ö–¶–ò–Ø –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø
        async function connectAndSetup() {
            if (!checkMetaMask()) return;

            try {
                logToConsole("–ó–∞–ø—Ä–æ—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤...");
                connectButton.disabled = true;
                loader.style.display = 'inline-block';
                
                // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–∫–∫–∞—É–Ω—Ç–∞–º
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                userAddress = accounts[0];
                statusSpan.textContent = `–ü–æ–¥–∫–ª—é—á–µ–Ω: ${userAddress.substring(0, 8)}...`;
                statusSpan.className = 'status-ok';
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                
                // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ç–∏
                const network = await provider.getNetwork();
                currentChainId = network.chainId.toString();
                networkSpan.textContent = `–°–µ—Ç—å: ${network.name} (ID: ${network.chainId})`;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
                await setupContract();
                
                // –í–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
                updateButtonStates(true);
                
                logToConsole("‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ! –ö–æ–Ω—Ç—Ä–∞–∫—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.");
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                window.ethereum.on('chainChanged', handleChainChanged);
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                
            } catch (error) {
                logToConsole(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
                if (error.code === 4001) {
                    logToConsole("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞–ø—Ä–æ—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è");
                }
                statusSpan.textContent = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
                statusSpan.className = 'status-error';
                connectButton.disabled = false;
            } finally {
                loader.style.display = 'none';
            }
        }

        // –§–£–ù–ö–¶–ò–Ø –ù–ê–°–¢–†–û–ô–ö–ò –ö–û–ù–¢–†–ê–ö–¢–ê
        async function setupContract() {
            try {
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                logToConsole(`–ö–æ–Ω—Ç—Ä–∞–∫—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ –∞–¥—Ä–µ—Å—É: ${contractAddress}`);
                return true;
            } catch (error) {
                logToConsole(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞: ${error.message}`);
                return false;
            }
        }

        // –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ò–Ø –ê–¢–¢–ï–°–¢–ê–¶–ò–ò
        async function createAttestation() {
            if (!contract) {
                logToConsole("‚ö†Ô∏è –ö–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
                return;
            }

            const assetInput = document.getElementById('assetInput').value.trim();
            const dataInput = document.getElementById('dataInput').value.trim();

            if (!assetInput || !dataInput) {
                logToConsole("‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏");
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
            if (assetInput === dataInput) {
                logToConsole("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏ –¥–∞–Ω–Ω—ã–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ?");
            }

            try {
                createButton.disabled = true;
                loader.style.display = 'inline-block';
                logToConsole("–°–æ–∑–¥–∞–Ω–∏–µ —Ö—ç—à–µ–π –∏–∑ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...");
                
                const assetHash = stringToBytes32(assetInput);
                const dataHash = stringToBytes32(dataInput);
                
                logToConsole(`Asset Hash: ${assetHash}`);
                logToConsole(`Data Hash: ${dataHash}`);
                
                logToConsole("–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...");
                
                const transaction = await contract.addAttestation(assetHash, dataHash);
                logToConsole(`‚è≥ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: ${transaction.hash}`);
                logToConsole("–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è... (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 15-30 —Å–µ–∫—É–Ω–¥)");
                
                // –ñ–¥–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                const receipt = await Promise.race([
                    transaction.wait(),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('–¢–∞–π–º–∞—É—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏')), 120000) // 2 –º–∏–Ω—É—Ç—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                    )
                ]);
                
                logToConsole(`‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –≤ –±–ª–æ–∫–µ ${receipt.blockNumber}!`);
                logToConsole("–ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω–∞ –≤ –±–ª–æ–∫—á–µ–π–Ω!");
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
                document.getElementById('assetInput').value = '';
                document.getElementById('dataInput').value = '';
                
            } catch (error) {
                logToConsole(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏: ${error.message}`);
                
                // –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ—à–∏–±–∫–∏
                if (error.code === 'ACTION_REJECTED') {
                    logToConsole("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ MetaMask");
                } else if (error.message.includes('–¢–∞–π–º–∞—É—Ç')) {
                    logToConsole("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞–≤–∏—Å–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ MetaMask.");
                } else if (error.code === 'INSUFFICIENT_FUNDS') {
                    logToConsole("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ETH –¥–ª—è –≥–∞–∑–∞. –ü–æ–ª—É—á–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ ETH.");
                } else if (error.data && error.data.message) {
                    logToConsole(`–û—à–∏–±–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞: ${error.data.message}`);
                }
                
            } finally {
                createButton.disabled = false;
                loader.style.display = 'none';
            }
        }

        // –§–£–ù–ö–¶–ò–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –ö–û–õ–ò–ß–ï–°–¢–í–ê –ê–¢–¢–ï–°–¢–ê–¶–ò–ô
        async function getAttestationCount() {
            const assetInput = document.getElementById('assetQueryInput').value.trim();
            
            if (!assetInput) {
                logToConsole("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–∞");
                return;
            }

            try {
                countButton.disabled = true;
                loader.style.display = 'inline-block';
                const assetHash = stringToBytes32(assetInput);
                
                logToConsole(`–ó–∞–ø—Ä–æ—Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–π –¥–ª—è —Ö—ç—à–∞: ${assetHash}`);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º provider –≤–º–µ—Å—Ç–æ signer –¥–ª—è –≤—ã–∑–æ–≤–æ–≤ view-—Ñ—É–Ω–∫—Ü–∏–π
                const contractWithProvider = new ethers.Contract(contractAddress, contractABI, provider);
                const count = await contractWithProvider.getAttestationCount(assetHash);
                
                logToConsole(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–π: ${count.toString()}`);
                
            } catch (error) {
                logToConsole(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: ${error.message}`);
                if (error.error && error.error.data) {
                    try {
                        // –ü—ã—Ç–∞–µ–º—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É
                        const decodedError = contract.interface.parseError(error.error.data);
                        logToConsole(`–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: ${decodedError.name}`);
                    } catch (e) {
                        logToConsole(`–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É: ${e.message}`);
                    }
                }
            } finally {
                countButton.disabled = false;
                loader.style.display = 'none';
            }
        }

        // –§–£–ù–ö–¶–ò–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –í–°–ï–• –ê–¢–¢–ï–°–¢–ê–¶–ò–ô
        async function getAllAttestations() {
            const assetInput = document.getElementById('assetQueryInput').value.trim();
            
            if (!assetInput) {
                logToConsole("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–∞");
                return;
            }

            try {
                getAllButton.disabled = true;
                loader.style.display = 'inline-block';
                const assetHash = stringToBytes32(assetInput);
                const resultsDiv = document.getElementById('attestationResults');
                
                logToConsole("–ó–∞–ø—Ä–æ—Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–π...");
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º provider –≤–º–µ—Å—Ç–æ signer –¥–ª—è –≤—ã–∑–æ–≤–æ–≤ view-—Ñ—É–Ω–∫—Ü–∏–π
                const contractWithProvider = new ethers.Contract(contractAddress, contractABI, provider);
                const count = await contractWithProvider.getAttestationCount(assetHash);
                const numCount = count.toNumber();
                
                if (numCount === 0) {
                    resultsDiv.innerHTML = "<p>–ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>";
                    logToConsole("–ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
                    return;
                }
                
                resultsDiv.innerHTML = `<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∞–∫—Ç–∏–≤–∞ "${assetInput}":</h3>`;
                logToConsole(`–ù–∞–π–¥–µ–Ω–æ ${numCount} –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–π. –ó–∞–≥—Ä—É–∑–∫–∞...`);
                
                for (let i = 0; i < numCount; i++) {
                    const attestation = await contractWithProvider.assetAttestations(assetHash, i);
                    
                    resultsDiv.innerHTML += `
                        <div class="attestation-card">
                            <p><strong>–ó–∞–ø–∏—Å—å #${i+1}:</strong></p>
                            <p>–ü—Ä–æ–≤–µ—Ä–∏–ª: ${attestation.verifier}</p>
                            <p>–•—ç—à –¥–∞–Ω–Ω—ã—Ö: ${attestation.dataHash}</p>
                            <p>–í—Ä–µ–º—è: ${new Date(attestation.timestamp * 1000).toLocaleString('ru-RU')}</p>
                        </div>
                    `;
                }
                
                logToConsole(`‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö ${numCount} –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞`);
                
            } catch (error) {
                logToConsole(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–π: ${error.message}`);
                if (error.error && error.error.data) {
                    try {
                        // –ü—ã—Ç–∞–µ–º—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É
                        const decodedError = contract.interface.parseError(error.error.data);
                        logToConsole(`–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: ${decodedError.name}`);
                    } catch (e) {
                        logToConsole(`–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É: ${e.message}`);
                    }
                }
            } finally {
                getAllButton.disabled = false;
                loader.style.display = 'none';
            }
        }

        // –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ MetaMask –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            if (checkMetaMask()) {
                logToConsole("MetaMask –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é.");
            }
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            connectButton.addEventListener('click', connectAndSetup);
            createButton.addEventListener('click', createAttestation);
            countButton.addEventListener('click', getAttestationCount);
            getAllButton.addEventListener('click', getAllAttestations);
        });
    </script>
</body>
</html>
