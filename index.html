<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoAttestation Protocol</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js" type="application/javascript"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; }
        .tab { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; border-radius: 8px 8px 0 0; }
        .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; }
        .tab button:hover { background-color: #ddd; }
        .tab button.active { background-color: #ccc; }
        .tabcontent { display: none; padding: 20px; border: 1px solid #ccc; border-top: none; border-radius: 0 0 8px 8px; animation: fadeEffect 0.5s; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }
        input, button, select, textarea { padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #result, #addResult { margin-top: 20px; padding: 15px; border-radius: 5px; display: none; }
        .verified { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .not-verified { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .verifier-info { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; margin-top: 10px; padding: 10px; border-radius: 4px; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>üîç CryptoAttestation Protocol</h1>
    <p>–î–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä –¥–æ–≤–µ—Ä–∏—è –¥–ª—è —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –∞–∫—Ç–∏–≤–æ–≤. <a href="https://github.com/testuem-art/cryptoattestation-protocol/blob/main/INSTRUCTIONS.md" target="_blank">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤</a></p>

    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'CheckTab')">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
        <button class="tablinks" onclick="openTab(event, 'AddTab')">–î–æ–±–∞–≤–∏—Ç—å –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—é</button>
    </div>

    <div id="CheckTab" class="tabcontent" style="display:block;">
        <h3>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞</h3>
        <p>–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ —Ç–æ–∫–µ–Ω–∞ –∏ ID –±–ª–æ–∫—á–µ–π–Ω–∞ (1 –¥–ª—è Ethereum, 137 –¥–ª—è Polygon, –∏ —Ç.–¥.)</p>
        <input type="text" id="contractAddress" placeholder="–ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0x1234...)">
        <input type="number" id="chainId" placeholder="ID –±–ª–æ–∫—á–µ–π–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1)" value="1">
        <button onclick="checkAttestations()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <div id="result"></div>
    </div>

    <div id="AddTab" class="tabcontent">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—é (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤)</h3>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à –∫–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞.</p>
        <input type="text" id="assetAddressInput" placeholder="–ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0x1234...)">
        <input type="number" id="assetChainInput" placeholder="ID –±–ª–æ–∫—á–µ–π–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1)" value="1">
        <select id="verificationTypeInput" onchange="toggleCustomInput()">
            <option value="AUDIT:PASSED">–ê—É–¥–∏—Ç –ø—Ä–æ–π–¥–µ–Ω</option>
            <option value="KYC:VERIFIED">KYC –ø—Ä–æ–π–¥–µ–Ω</option>
            <option value="SAFE:CONFIRMED">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</option>
            <option value="CUSTOM">–î—Ä—É–≥–æ–µ...</option>
        </select>
        <input type="text" id="customVerificationInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π —Ç–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏" style="display:none;">
        <button onclick="addAttestation()" id="submitButton">–î–æ–±–∞–≤–∏—Ç—å –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—é</button>
        <div id="addResult"></div>
    </div>

    <script>
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø - –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –î–ê–ù–ù–´–ï!
        const contractAddress = "0x6080604052348015600e575f5ffd5b503360025f6101000a81548173"; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
        const abi = [ {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"assetHash","type":"bytes32"},{"indexed":true,"internalType":"address","name":"verifier","type":"address"},{"indexed":false,"internalType":"bytes32","name":"dataHash","type":"bytes32"}],"name":"AttestationAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"verifier","type":"address"}],"name":"VerifierAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"verifier","type":"address"}],"name":"VerifierRemoved","type":"event"},{"inputs":[{"internalType":"bytes32","name":"assetHash","type":"bytes32"},{"internalType":"bytes32","name":"dataHash","type":"bytes32"}],"name":"addAttestation","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_verifier","type":"address"}],"name":"addVerifier","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"assetAttestations","outputs":[{"internalType":"address","name":"verifier","type":"address"},{"internalType":"bytes32","name":"dataHash","type":"bytes32"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"approvedVerifiers","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"assetHash","type":"bytes32"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getAttestation","outputs":[{"internalType":"address","name":"verifier","type":"address"},{"internalType":"bytes32","name":"dataHash","type":"bytes32"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"assetHash","type":"bytes32"}],"name":"getAttestationCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_verifier","type":"address"}],"name":"removeVerifier","outputs":[],"stateMutability":"nonpayable","type":"function"} ]; // ABI –≤–∞—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞

        let verifiersList = {};

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ç–∏–ø–∞
        function toggleCustomInput() {
            const customInput = document.getElementById('customVerificationInput');
            const selection = document.getElementById('verificationTypeInput');
            customInput.style.display = selection.value === 'CUSTOM' ? 'block' : 'none';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –∏–∑ GitHub Issues
        async function fetchVerifiers() {
            const repoOwner = 'testuem-art'; // –í–∞—à –ª–æ–≥–∏–Ω GitHub
            const repoName = 'cryptoattestation-protocol'; // –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            const issueNumber = 1; // –ù–æ–º–µ—Ä issue —Å —Å–ø–∏—Å–∫–æ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤

            try {
                const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/issues/${issueNumber}/comments`);
                const comments = await response.json();
                
                if (comments.length > 0) {
                    const commentText = comments[0].body;
                    const verifierLines = commentText.split('\n').filter(line => line.includes('–ê–¥—Ä–µ—Å:'));
                    
                    const verifiers = {};
                    verifierLines.forEach(line => {
                        const addressMatch = line.match(/–ê–¥—Ä–µ—Å:\s*(0x[a-fA-F0-9]{40})/);
                        const nameMatch = line.match(/–ò–º—è:\s*([^|]+)/);
                        const websiteMatch = line.match(/–°–∞–π—Ç:\s*([^|]+)/);
                        
                        if (addressMatch && nameMatch) {
                            verifiers[addressMatch[1].toLowerCase()] = {
                                name: nameMatch[1].trim(),
                                website: websiteMatch ? websiteMatch[1].trim() : ''
                            };
                        }
                    });
                    
                    return verifiers;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤:', error);
            }
            
            return {};
        }

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–π
        async function checkAttestations() {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = '';
            resultDiv.innerText = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const contract = new ethers.Contract(contractAddress, abi, provider);

            const assetAddress = document.getElementById('contractAddress').value;
            const chainId = document.getElementById('chainId').value;
            const assetHash = ethers.utils.id(`${chainId}:${assetAddress}`.toLowerCase());

            try {
                const count = await contract.getAttestationCount(assetHash);
                verifiersList = await fetchVerifiers();
                
                if (count > 0) {
                    let resultText = `<h4>‚úÖ –£ —ç—Ç–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –µ—Å—Ç—å ${count} –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–π!</h4>`;
                    
                    for (let i = 0; i < count; i++) {
                        const attestation = await contract.getAttestation(assetHash, i);
                        const verifierAddress = attestation.verifier.toLowerCase();
                        const verifierInfo = verifiersList[verifierAddress] || {name: verifierAddress};
                        
                        resultText += `<div class="verifier-info">`;
                        resultText += `<strong>–ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è ${i+1}:</strong> ${verifierInfo.name}<br>`;
                        if (verifierInfo.website) {
                            resultText += `<strong>–°–∞–π—Ç:</strong> <a href="${verifierInfo.website}" target="_blank">${verifierInfo.website}</a><br>`;
                        }
                        resultText += `<strong>–¢–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏:</strong> ${attestation.dataHash}<br>`;
                        resultText += `<strong>–í—Ä–µ–º—è:</strong> ${new Date(attestation.timestamp * 1000).toLocaleString()}`;
                        resultText += `</div>`;
                    }
                    
                    resultDiv.innerHTML = resultText;
                    resultDiv.className = 'verified';
                } else {
                    resultDiv.innerHTML = '‚ùå –£ —ç—Ç–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–π. <strong>–û—Å—Ç–æ—Ä–æ–∂–Ω–æ!</strong>';
                    resultDiv.className = 'not-verified';
                }
            } catch (error) {
                resultDiv.innerHTML = '‚ö†Ô∏è <strong>–û—à–∏–±–∫–∞:</strong> ' + error.message;
                resultDiv.className = 'not-verified';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏
        async function addAttestation() {
            const addResultDiv = document.getElementById('addResult');
            const button = document.getElementById('submitButton');
            addResultDiv.style.display = 'block';
            addResultDiv.className = '';
            addResultDiv.innerText = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';

            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                const signer = provider.getSigner();
                const contract = new ethers.Contract(contractAddress, abi, signer);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∞–¥—Ä–µ—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º
                const currentAddress = await signer.getAddress();
                const isVerifier = await contract.approvedVerifiers(currentAddress);

                if (!isVerifier) {
                    addResultDiv.innerHTML = '‚ùå <strong>–û—à–∏–±–∫–∞:</strong> –í–∞—à –∞–¥—Ä–µ—Å –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤!';
                    addResultDiv.className = 'not-verified';
                    return;
                }

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ö–µ—à–∏ –∏–∑ —á–∏—Ç–∞–µ–º—ã—Ö —Å—Ç—Ä–æ–∫
                const assetAddress = document.getElementById('assetAddressInput').value;
                const chainId = document.getElementById('assetChainInput').value;
                const assetHash = ethers.utils.id(`${chainId}:${assetAddress}`.toLowerCase());

                let verificationType = document.getElementById('verificationTypeInput').value;
                if (verificationType === 'CUSTOM') {
                    verificationType = document.getElementById('customVerificationInput').value;
                }
                const dataHash = ethers.utils.id(verificationType);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                const tx = await contract.addAttestation(assetHash, dataHash);
                addResultDiv.innerHTML = `‚úÖ <strong>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</strong> –•–µ—à: ${tx.hash}. –û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...`;
                addResultDiv.className = 'info';

                await tx.wait();
                addResultDiv.innerHTML = `‚úÖ <strong>–ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–ª–æ–∫—á–µ–π–Ω!</strong>`;
                addResultDiv.className = 'verified';

                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
                document.getElementById('assetAddressInput').value = '';
                document.getElementById('customVerificationInput').value = '';

            } catch (error) {
                addResultDiv.innerHTML = '‚ùå <strong>–û—à–∏–±–∫–∞:</strong> ' + error.message;
                addResultDiv.className = 'not-verified';
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            fetchVerifiers(); // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
        };
    </script>
</body>
</html>
